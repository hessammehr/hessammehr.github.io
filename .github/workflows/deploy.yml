name: Build Website

on:
  push:
    branches:
      - content

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Install Pandoc
        run: sudo apt-get install pandoc

      - name: Download Primer CSS and Highlight.js themes
        run: |
          curl -O https://unpkg.com/@primer/css/dist/primer.css
          curl -o light.css https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.7.2/styles/github.min.css
          curl -o dark.css https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.7.2/styles/night-owl.min.css

      - name: Generate blog index
        run: |
          cp blog/index.template.md blog/index.md
          
          for file in $(find ./blog/posts -name "*.md" | sort -r); do
            date=$(basename "$file" | cut -d- -f1,2,3)
            title=$(sed -n '1s/^# //p' "$file")
            filename=$(basename "$file")
            echo "| $date | [$title]" >> blog/index.md
          done
          
          echo "" >> blog/index.md
          
          for file in $(find ./blog/posts -name "*.md" | sort -r); do
            title=$(sed -n '1s/^# //p' "$file")
            filename=$(basename "$file")
            echo "[$title]: /blog/posts/$filename" >> blog/index.md
          done

      - name: Convert blog Markdown files to HTML
        run: |
          for file in $(find ./blog/posts -name "*.md"); do
            pandoc -s "$file" \
              --template=_template.html \
              --no-highlight \
              -o "${file%.md}.html"
          done

      - name: Convert CV markdown to HTML
        run: |
          pandoc -s CV.md -o CV.html

      - name: Convert blog index to HTML
        run: |
          pandoc -s blog/index.md \
            -c /style.css \
            --lua-filter=<(echo '
              function Link(el)
                el.target = el.target:gsub("%.md$", ".html")
                return el
              end
            ') \
            -o blog/index.html

      - name: Convert main index.md to HTML
        run: |
          pandoc -s index.md -c style.css -o index.html

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_branch: master
          publish_dir: ./